# API Design Specification

This document defines the RESTful API for the Perseus platform. The API enables interactions between the web frontend, mobile clients, and autonomous robots. It follows standard REST patterns and provides a foundation for the Perseus MCP server.

## API Design Principles

The Perseus API adheres to the following principles to ensure consistency and ease of use, as described in [[00-Perseus-Overview]].

- **Resource-Oriented**: Endpoints represent nouns like `tenants`, `robots`, and `messages`.
- **HTTP Semantics**: 
    - `GET` for retrieving data without side effects.
    - `POST` for creating new resources.
    - `PUT` for full resource updates.
    - `DELETE` for removing resources.
- **Versioning**: All paths start with `/api/v1` to allow for future changes without breaking existing clients.
- **JSON Format**: All request bodies and responses use standard JSON.
- **Statelessness**: Each request contains all necessary information for processing.

## Authentication

Perseus supports multiple authentication methods based on the client type, detailed in [[03-Auth-and-Security]].

### Human Authentication
Users authenticate via the login endpoint to receive a JWT. This token must be included in the `Authorization` header.

```text
Authorization: Bearer <jwt_token>
```

### Robot Authentication
Robots use a long-lived `robot-token` generated by the platform. This token allows robots to interact with the API through the MCP server.

```text
X-Robot-Token: <robot_token>
```

### API Key
Third-party integrations can use an API key for server-to-server communication.

```text
X-API-Key: <api_key>
```

## Endpoint Groups

### Auth Endpoints
Manage user registration, login, and identity verification.

- `POST /api/v1/auth/signup`: Register a new account.
- `POST /api/v1/auth/login`: Authenticate and receive a JWT.
- `POST /api/v1/auth/verify-phone`: Submit a verification code.
- `POST /api/v1/auth/select-tenant`: Switch context to a specific tenant.

### Tenant Management
Manage organizational boundaries as described in [[02-Data-Model]].

- `GET /api/v1/tenants`: List all tenants the user belongs to.
- `POST /api/v1/tenants`: Create a new tenant.
- `GET /api/v1/tenants/{id}`: Get tenant details.
- `PUT /api/v1/tenants/{id}`: Update tenant configuration.
- `DELETE /api/v1/tenants/{id}`: Remove a tenant.
- `GET /api/v1/tenants/{id}/users`: List users within a tenant.

### Team Management
Organize users and robots into functional units.

- `GET /api/v1/teams`: List teams within the active tenant.
- `POST /api/v1/teams`: Create a new team.
- `GET /api/v1/teams/{id}`: Get team details.
- `PUT /api/v1/teams/{id}`: Update team settings.
- `DELETE /api/v1/teams/{id}`: Disband a team.
- `POST /api/v1/teams/{id}/members`: Add a user or robot to a team.
- `DELETE /api/v1/teams/{id}/members/{memberId}`: Remove a member.

### Robot Management
Manage robot lifecycle and configuration.

- `GET /api/v1/robots`: List robots available to the user.
- `POST /api/v1/robots`: Register a new robot instance.
- `GET /api/v1/robots/{id}`: Get robot status and metadata.
- `PUT /api/v1/robots/{id}`: Update robot settings.
- `DELETE /api/v1/robots/{id}`: Decommission a robot.

### ChatGroup Management
Handle communication channels as outlined in [[05-Chat-System]].

- `GET /api/v1/chatgroups`: List active chat groups.
- `POST /api/v1/chatgroups`: Create a new chat group.
- `GET /api/v1/chatgroups/{id}`: Get group metadata and members.
- `PUT /api/v1/chatgroups/{id}`: Modify group settings or membership.
- `DELETE /api/v1/chatgroups/{id}`: Archive or delete a group.

### Message Management
Exchange information within chat groups.

- `GET /api/v1/chatgroups/{id}/messages`: Retrieve message history.
- `POST /api/v1/chatgroups/{id}/messages`: Send a new message.
- `PUT /api/v1/messages/{id}`: Edit a previous message.
- `DELETE /api/v1/messages/{id}`: Remove a message from history.

### Workspace Files
Manage files shared within specific contexts. Robots can only access files in the chatgroups where they are members.

- `GET /api/v1/chatgroups/{id}/files`: List files associated with a chat group.
- `POST /api/v1/chatgroups/{id}/files`: Upload a file to a chat group.
- `GET /api/v1/files/{id}`: Download a specific file.
- `DELETE /api/v1/files/{id}`: Delete a file.

## Request/Response Examples

### 1. User Signup
**POST** `/api/v1/auth/signup`
```json
{
  "email": "user@example.com",
  "password": "securepassword123",
  "name": "John Doe",
  "phone": "+1234567890"
}
```

### 2. Send Message
**POST** `/api/v1/chatgroups/cg_789/messages`
```json
{
  "content": "Hello, how can I help you today?",
  "type": "text",
  "metadata": {
    "robot_id": "bot_456"
  }
}
```

### 3. Message Response
**Status 201 Created**
```json
{
  "id": "msg_001",
  "chatgroup_id": "cg_789",
  "sender_id": "bot_456",
  "content": "Hello, how can I help you today?",
  "created_at": "2024-02-19T10:00:00Z"
}
```

### 4. List Robots
**GET** `/api/v1/robots`
```json
{
  "robots": [
    {
      "id": "bot_001",
      "name": "Assistant-X1",
      "status": "online",
      "capabilities": ["text-generation", "image-analysis"]
    },
    {
      "id": "bot_002",
      "name": "Cleaner-Bot",
      "status": "offline",
      "capabilities": ["cleaning"]
    }
  ],
  "total": 2
}
```

### 5. Error Response
**Status 404 Not Found**
```json
{
  "error": {
    "code": "resource_not_found",
    "message": "The requested robot could not be found.",
    "details": {
      "robot_id": "bot_999"
    }
  }
}
```

## Error Format

The API uses a consistent error structure. Errors include a machine-readable code, a human-readable message, and optional context details.

```json
{
  "error": {
    "code": "string",
    "message": "string",
    "details": {}
  }
}
```

Common status codes include:
- `400 Bad Request`: Validation errors or malformed JSON.
- `401 Unauthorized`: Missing or invalid authentication.
- `403 Forbidden`: Authenticated but lacking permission for the resource.
- `404 Not Found`: The resource does not exist.
- `429 Too Many Requests`: Rate limit exceeded.
- `500 Internal Server Error`: An unexpected problem occurred.

## Rate Limiting

Perseus implements rate limiting to protect system stability. Limits are applied based on the authentication token.

- **Standard Users**: 1000 requests per hour.
- **Robots**: 5000 requests per hour.
- **Internal Services**: Unlimited within the private network.

Exceeding these limits results in a `429 Too Many Requests` response.

## Endpoint Summary Table

| Method | Path | Description | Auth Required |
|--------|------|-------------|---------------|
| POST | `/api/v1/auth/signup` | Register user | No |
| POST | `/api/v1/auth/login` | Get JWT | No |
| POST | `/api/v1/auth/verify-phone` | Verify phone | Yes |
| GET | `/api/v1/tenants` | List tenants | Yes |
| POST | `/api/v1/tenants` | Create tenant | Yes |
| GET | `/api/v1/robots` | List robots | Yes |
| POST | `/api/v1/robots` | Register robot | Yes |
| GET | `/api/v1/chatgroups` | List chat groups | Yes |
| POST | `/api/v1/chatgroups` | Create chat group | Yes |
| POST | `/api/v1/chatgroups/{id}/messages` | Send message | Yes |
| GET | `/api/v1/chatgroups/{id}/messages` | Get history | Yes |
| GET | `/api/v1/chatgroups/{id}/files` | List files | Yes |
| POST | `/api/v1/chatgroups/{id}/files` | Upload file | Yes |
| GET | `/api/v1/files/{id}` | Download file | Yes |
| DELETE | `/api/v1/files/{id}` | Delete file | Yes |
| PUT | `/api/v1/messages/{id}` | Edit message | Yes |
| DELETE | `/api/v1/messages/{id}` | Delete message | Yes |
| GET | `/api/v1/teams` | List teams | Yes |
| POST | `/api/v1/teams` | Create team | Yes |
| DELETE | `/api/v1/teams/{id}` | Disband team | Yes |
